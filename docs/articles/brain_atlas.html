<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Large-Scale Deconvolution: Human Brain Atlas â€¢ cellGeometry</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Large-Scale Deconvolution: Human Brain Atlas">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cellGeometry</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/intro.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/algorithm.html">Mathematical Foundations</a></li>
    <li><a class="dropdown-item" href="../articles/visualization.html">Visualization Guide</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">All articles</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/intro.html">Quick Start Guide</a></li>
    <li><a class="dropdown-item" href="../articles/real_world.html">Real-World Application</a></li>
    <li><a class="dropdown-item" href="../articles/brain_atlas.html">Large-Scale: Brain Atlas</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Zaoqu-Liu/cellGeometry"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Large-Scale Deconvolution: Human Brain Atlas</h1>
                        <h4 data-toc-skip class="author">Zaoqu Liu,
Myles Lewis</h4>
            
            <h4 data-toc-skip class="date">2026-02-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Zaoqu-Liu/cellGeometry/blob/HEAD/vignettes/brain_atlas.Rmd" class="external-link"><code>vignettes/brain_atlas.Rmd</code></a></small>
      <div class="d-none name"><code>brain_atlas.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="brain-atlas">Brain Atlas<a class="anchor" aria-label="anchor" href="#brain-atlas"></a>
</h2>
<p>We use the Human Brain Atlas 1.0 dataset as an example of
deconvolution of a large single cell dataset. The brain atlas data is
split into 2 files, one containing neurons only whih has roughly 2.5
million cells, while the other dataset contains the remaining
non-neuronal cells. For a smaller, simpler example see the cellGeometry
quickstart vignette. The data is available on the CZ cellxgene
repository, described here: <a href="https://cellxgene.cziscience.com/collections/283d65eb-dd53-496d-adb7-7570c7caa443" class="external-link uri">https://cellxgene.cziscience.com/collections/283d65eb-dd53-496d-adb7-7570c7caa443</a></p>
<p>The h5ad file for all neurons (33 Gb) can be downloaded directly
using this link: <a href="https://datasets.cellxgene.cziscience.com/c2f66cd5-4ff4-4578-876c-55783a57cf8f.h5ad" class="external-link uri">https://datasets.cellxgene.cziscience.com/c2f66cd5-4ff4-4578-876c-55783a57cf8f.h5ad</a></p>
<p>The h5ad file for the remaining 888,263 non-neuronal cells (4 Gb) can
be downloaded from this link: <a href="https://datasets.cellxgene.cziscience.com/99f27be8-9fac-451e-9723-9e4c7191589e.h5ad" class="external-link uri">https://datasets.cellxgene.cziscience.com/99f27be8-9fac-451e-9723-9e4c7191589e.h5ad</a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/theislab/zellkonverter" class="external-link">zellkonverter</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zaoqu-liu.github.io/cellGeometry/">cellGeometry</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="neurons">Neurons<a class="anchor" aria-label="anchor" href="#neurons"></a>
</h3>
<p>We load the data from the h5ad file and extract the single cell
matrix.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 33 Gb</span></span>
<span><span class="co"># 2,480,956 cells</span></span>
<span><span class="va">brain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/zellkonverter/man/readH5AD.html" class="external-link">readH5AD</a></span><span class="op">(</span><span class="st">"../c2f66cd5-4ff4-4578-876c-55783a57cf8f.h5ad"</span>,</span>
<span>                  use_hdf5 <span class="op">=</span> <span class="cn">TRUE</span>, reader <span class="op">=</span> <span class="st">"R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mat</span> <span class="op">&lt;-</span> <span class="va">brain</span><span class="op">@</span><span class="va">assays</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">brain</span><span class="op">)</span>  <span class="co"># need to add rownames (genes)</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="va">brain</span><span class="op">@</span><span class="va">colData</span><span class="op">@</span><span class="va">listData</span></span></code></pre></div>
<p>We then define the cellMarkers objects. This is the most time
consuming part of the analysis. There are options here for which
metadata column to use for defining subclasses and groups. Here we use
<code>roi</code> and <code>supercluster_term</code> as subclass and
group respectively. Other possible columns in <code>meta</code> are
<code>dissection</code> (fine subregions) and <code>ROIgroupfine</code>
(similar to tissue region).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># shows possible cell cluster subclasses and groups</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">meta</span><span class="op">$</span><span class="va">roi</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">meta</span><span class="op">$</span><span class="va">supercluster_term</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cellMarkers.html">cellMarkers</a></span><span class="op">(</span><span class="va">mat</span>, subclass <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">roi</span>,</span>
<span>                  cellgroup <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">supercluster_term</span>, </span>
<span>                  dual_mean <span class="op">=</span> <span class="cn">TRUE</span>, cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="co"># 27 mins (intel 8 cores)</span></span></code></pre></div>
<p>We load a recent ensembl database to convert ensembl ids to gene
names. This is optional and can be done at a later stage for users that
prefer to use ensembl ids for analysis and only convert to gene names
only during plotting.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">AnnotationHub</span><span class="op">)</span></span>
<span><span class="va">ah</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">AnnotationHub</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ensDb_v110</span> <span class="op">&lt;-</span> <span class="va">ah</span><span class="op">[[</span><span class="st">"AH113665"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">mk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gene2symbol.html">gene2symbol</a></span><span class="op">(</span><span class="va">mk</span>, <span class="va">ensDb_v110</span><span class="op">)</span></span></code></pre></div>
<p>We can visualise the signature heatmap as follows.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/signature_heatmap.html">signature_heatmap</a></span><span class="op">(</span><span class="va">mk</span>, text <span class="op">=</span> <span class="cn">FALSE</span>, show_row_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  row_title_rot <span class="op">=</span> <span class="fl">0</span>, column_title_rot <span class="op">=</span> <span class="fl">45</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="non-neuronal-cells">Non-neuronal cells<a class="anchor" aria-label="anchor" href="#non-neuronal-cells"></a>
</h3>
<p>Next we generate cellMarkers for the non-neuronal cells.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># non-neuronal cells</span></span>
<span><span class="co"># 888,263 cells</span></span>
<span><span class="co"># 4 Gb</span></span>
<span><span class="va">brainNN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/zellkonverter/man/readH5AD.html" class="external-link">readH5AD</a></span><span class="op">(</span><span class="st">"../99f27be8-9fac-451e-9723-9e4c7191589e.h5ad"</span>,</span>
<span>                    use_hdf5 <span class="op">=</span> <span class="cn">TRUE</span>, reader <span class="op">=</span> <span class="st">"R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mat2</span> <span class="op">&lt;-</span> <span class="va">brainNN</span><span class="op">@</span><span class="va">assays</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">brainNN</span><span class="op">)</span>  <span class="co"># add rownames (genes)</span></span>
<span><span class="va">meta2</span> <span class="op">&lt;-</span> <span class="va">brainNN</span><span class="op">@</span><span class="va">colData</span><span class="op">@</span><span class="va">listData</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">meta2</span><span class="op">$</span><span class="va">supercluster_term</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">meta2</span><span class="op">$</span><span class="va">cell_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mkNN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cellMarkers.html">cellMarkers</a></span><span class="op">(</span><span class="va">mat2</span>, subclass <span class="op">=</span> <span class="va">meta2</span><span class="op">$</span><span class="va">cell_type</span>,</span>
<span>                    cellgroup <span class="op">=</span> <span class="va">meta2</span><span class="op">$</span><span class="va">supercluster_term</span>,</span>
<span>                    dual_mean <span class="op">=</span> <span class="cn">TRUE</span>, cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="co"># 9 mins (intel 8 cores)</span></span>
<span></span>
<span><span class="va">mkNN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gene2symbol.html">gene2symbol</a></span><span class="op">(</span><span class="va">mkNN</span>, <span class="va">ensDb_v110</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/signature_heatmap.html">signature_heatmap</a></span><span class="op">(</span><span class="va">mkNN</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="merging-signatures">Merging signatures<a class="anchor" aria-label="anchor" href="#merging-signatures"></a>
</h2>
<p>Next we merge the cellMarkers objects for both the neuronal and
non-neuronal datasets. In this example we set <code>transform</code> to
<code>"none"</code> as we know that both single-cell datasets were
performed using the same chemistry and same setup, so there is no major
difference in scaling between the datasets. When merging other single
cell datasets which are more disparate then we recommend leaving
<code>transform</code> as its default <code>"qq"</code>, which uses
quantile mapping to map one single-cell dataset to another based on the
distribution of the gene means across the subclasses.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mkm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mergeMarkers.html">mergeMarkers</a></span><span class="op">(</span><span class="va">mk</span>, <span class="va">mkNN</span>, transform <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">mkm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/updateMarkers.html">updateMarkers</a></span><span class="op">(</span><span class="va">mkm</span>, expfilter <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>We can view merged gene signature from both single cell datasets
using <code><a href="../reference/signature_heatmap.html">signature_heatmap()</a></code>. Here genes are scaled using
sphere scaling to highlight the differences between subclasses. This
mimics the signature matrix applied when
<code>weight_method = "equal"</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/signature_heatmap.html">signature_heatmap</a></span><span class="op">(</span><span class="va">mkm</span>, top <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                  text <span class="op">=</span> <span class="cn">FALSE</span>, show_row_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  row_title_rot <span class="op">=</span> <span class="fl">0</span>, column_title_rot <span class="op">=</span> <span class="fl">75</span>,</span>
<span>                  scale <span class="op">=</span> <span class="st">"sphere"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brain_sig.png" class="r-plt" alt="" width="100%"></p>
<p>The full signature matrix is very large containing 1542 genes across
116 subclasses. So we can focus in on a particular group of cell types
as follows.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view signature for just the Amygdata excitatory group</span></span>
<span><span class="fu"><a href="../reference/signature_heatmap.html">signature_heatmap</a></span><span class="op">(</span><span class="va">mkm</span>, subset <span class="op">=</span> <span class="st">"Amygdala excitatory"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brain_sig_amygdala.png" class="r-plt" alt="" width="50%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="simulating-pseudobulk">Simulating pseudobulk<a class="anchor" aria-label="anchor" href="#simulating-pseudobulk"></a>
</h2>
<p>To generate a simulated pseudobulk dataset, we generate simulation
datasets based on sampling each of the neuronal and non-neuronal raw
single-cell count matrices.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate neuronal cell count samples</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">sim_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_samples.html">generate_samples</a></span><span class="op">(</span><span class="va">mk</span>, <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">sim_percent</span> <span class="op">&lt;-</span> <span class="va">sim_counts</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">sim_counts</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># simulate neuronal bulk</span></span>
<span><span class="co"># sample from neuronal count matrix</span></span>
<span><span class="co"># 35 mins (Intel)</span></span>
<span><span class="va">sim_sampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_bulk.html">simulate_bulk</a></span><span class="op">(</span><span class="va">mat</span>, <span class="va">sim_counts</span>, <span class="va">meta</span><span class="op">$</span><span class="va">roi</span>,</span>
<span>                             times <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sim_sampled</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gene2symbol.html">gene2symbol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sim_sampled</span><span class="op">)</span>, <span class="va">ensDb_v110</span><span class="op">)</span></span></code></pre></div>
<p>Once we have generated the simulation dataset from the neuronal
matrix, the code below shows how to deconvolute it alone without the
merging of the non-neuronal cells. This can be skipped if you want to
merge with the non-neuronal cells and deconvolute the whole lot.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/deconvolute.html">deconvolute</a></span><span class="op">(</span><span class="va">mk</span>, <span class="va">sim_sampled</span>,</span>
<span>                   arith_mean <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   use_filter <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">mset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">sim_percent</span>, <span class="va">fit</span><span class="op">$</span><span class="va">subclass</span><span class="op">$</span><span class="va">percent</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mset</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"../brain_sim_neuron.pdf"</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">12.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_set.html">plot_set</a></span><span class="op">(</span><span class="va">sim_counts</span>, <span class="va">fit</span><span class="op">$</span><span class="va">subclass</span><span class="op">$</span><span class="va">output</span>, show_zero <span class="op">=</span> <span class="cn">T</span>,</span>
<span>         mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_set.html">plot_set</a></span><span class="op">(</span><span class="va">sim_percent</span>, <span class="va">fit</span><span class="op">$</span><span class="va">subclass</span><span class="op">$</span><span class="va">percent</span>, show_zero <span class="op">=</span> <span class="cn">T</span>,</span>
<span>         mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Next we set up the simulated bulk data from the non-neuronal single
cell matrix.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate non-neuronal cell count samples</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">sim_countsNN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_samples.html">generate_samples</a></span><span class="op">(</span><span class="va">mkNN</span>, <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">sim_percentNN</span> <span class="op">&lt;-</span> <span class="va">sim_countsNN</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">sim_countsNN</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># simulate non-neuronal bulk</span></span>
<span><span class="co"># sample from non-neuronal count matrix</span></span>
<span><span class="co"># 6.32 mins (Intel)</span></span>
<span><span class="va">sim_sampledNN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_bulk.html">simulate_bulk</a></span><span class="op">(</span><span class="va">mat2</span>, <span class="va">sim_countsNN</span>, <span class="va">meta2</span><span class="op">$</span><span class="va">cell_type</span>,</span>
<span>                               times <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sim_sampledNN</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gene2symbol.html">gene2symbol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sim_sampledNN</span><span class="op">)</span>, <span class="va">ensDb_v110</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="merging-simulated-data">Merging simulated data<a class="anchor" aria-label="anchor" href="#merging-simulated-data"></a>
</h3>
<p>The following code merges the pseudobulk count matrices from neuronal
and non-neuronal cells and updates the ground truth matrix of cell
counts.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># check genenames are the same in both datasets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sim_sampled</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sim_sampledNN</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## TRUE</span></span>
<span></span>
<span><span class="co"># merge pseudobulk counts</span></span>
<span><span class="va">sim_sampled_merge</span> <span class="op">&lt;-</span> <span class="va">sim_sampled</span> <span class="op">+</span> <span class="va">sim_sampledNN</span></span>
<span></span>
<span><span class="co"># merge sample cell counts (ground truth)</span></span>
<span><span class="va">sim_counts_merge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">sim_counts</span>, <span class="va">sim_countsNN</span><span class="op">)</span></span>
<span><span class="va">sim_percent_merge</span> <span class="op">&lt;-</span> <span class="va">sim_counts_merge</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">sim_counts_merge</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="deconvolution">Deconvolution<a class="anchor" aria-label="anchor" href="#deconvolution"></a>
</h2>
<p>We run the deconvolution on the merged pseudobulk count matrix.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/deconvolute.html">deconvolute</a></span><span class="op">(</span><span class="va">mkm</span>, <span class="va">sim_sampled_merge</span>,</span>
<span>                    arith_mean <span class="op">=</span> <span class="cn">TRUE</span>, use_filter <span class="op">=</span> <span class="cn">FALSE</span>, cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="co"># 19.2 secs (ARM, 1 core)</span></span>
<span><span class="co"># 3.22 secs (ARM, 8 cores)</span></span></code></pre></div>
<p>Finally we compare with ground truth and generate summary statistics
and scatter plots comparing ground truth cell counts/percentages against
the deconvolution predictions.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">sim_percent_merge</span>, <span class="va">fitm</span><span class="op">$</span><span class="va">subclass</span><span class="op">$</span><span class="va">percent</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mset</span><span class="op">)</span></span>
<span><span class="co">##  pearson.rsq          Rsq               RMSE        </span></span>
<span><span class="co">## Min.   :0.6634   Min.   :-0.5747   Min.   :0.02479  </span></span>
<span><span class="co">## 1st Qu.:0.9298   1st Qu.: 0.9146   1st Qu.:0.05244  </span></span>
<span><span class="co">## Median :0.9789   Median : 0.9718   Median :0.07411  </span></span>
<span><span class="co">## Mean   :0.9452   Mean   : 0.8969   Mean   :0.10484  </span></span>
<span><span class="co">## 3rd Qu.:0.9917   3rd Qu.: 0.9855   3rd Qu.:0.11979  </span></span>
<span><span class="co">## Max.   :0.9999   Max.   : 0.9958   Max.   :0.51257  </span></span></code></pre></div>
<p>We visualise the deconvoluted sample results against the ground truth
using scatter plots for each cell subclass using the function
<code><a href="../reference/plot_set.html">plot_set()</a></code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scatter plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"../brain_sim_merge.pdf"</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">12.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_set.html">plot_set</a></span><span class="op">(</span><span class="va">sim_counts_merge</span>, <span class="va">fitm</span><span class="op">$</span><span class="va">subclass</span><span class="op">$</span><span class="va">output</span>, show_zero <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>         mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_set.html">plot_set</a></span><span class="op">(</span><span class="va">sim_percent_merge</span>, <span class="va">fitm</span><span class="op">$</span><span class="va">subclass</span><span class="op">$</span><span class="va">percent</span>, show_zero <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>         mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Pages 1-2 are cell counts and pages 3-4 are cell percentages. Page 3
of the pdf of scatter plots will look as follows, with ground truth on
the x axis and predicted deconvoluted cell percentages on the y
axis.</p>
<p><img src="brain_plotset.png" class="r-plt" alt="" width="100%"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/Zaoqu-Liu" class="external-link">Zaoqu Liu</a> and <a href="https://github.com/myles-lewis" class="external-link">Myles Lewis</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
