<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mathematical Foundations of cellGeometry â€¢ cellGeometry</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mathematical Foundations of cellGeometry">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cellGeometry</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/intro.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/algorithm.html">Mathematical Foundations</a></li>
    <li><a class="dropdown-item" href="../articles/visualization.html">Visualization Guide</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">All articles</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/intro.html">Quick Start Guide</a></li>
    <li><a class="dropdown-item" href="../articles/real_world.html">Real-World Application</a></li>
    <li><a class="dropdown-item" href="../articles/brain_atlas.html">Large-Scale: Brain Atlas</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Zaoqu-Liu/cellGeometry"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Mathematical Foundations of cellGeometry</h1>
                        <h4 data-toc-skip class="author">Zaoqu Liu,
Myles Lewis</h4>
            
            <h4 data-toc-skip class="date">2026-02-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Zaoqu-Liu/cellGeometry/blob/HEAD/vignettes/algorithm.Rmd" class="external-link"><code>vignettes/algorithm.Rmd</code></a></small>
      <div class="d-none name"><code>algorithm.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><strong>cellGeometry</strong> implements a novel geometric approach
for bulk RNA-Seq deconvolution using single-cell RNA-Seq reference data.
This vignette provides a detailed explanation of the mathematical
foundations underlying the algorithm.</p>
<p>The core insight is that cell type proportions can be estimated by
treating gene expression profiles as vectors in high-dimensional space
and computing their projections onto cell type-specific signatures.</p>
</div>
<div class="section level2">
<h2 id="vector-space-representation">Vector Space Representation<a class="anchor" aria-label="anchor" href="#vector-space-representation"></a>
</h2>
<div class="section level3">
<h3 id="gene-expression-as-vectors">Gene Expression as Vectors<a class="anchor" aria-label="anchor" href="#gene-expression-as-vectors"></a>
</h3>
<p>In cellGeometry, we represent gene expression data in a vector space
framework:</p>
<ul>
<li>
<strong>Genes</strong> are treated as observations (rows)</li>
<li>
<strong>Cell types</strong> define the coordinate axes
(dimensions)</li>
<li>Each <strong>gene</strong> is a vector pointing in the direction of
its expression pattern</li>
</ul>
<p>For a dataset with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
genes and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
cell types, the gene expression matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ†</mi><mo>âˆˆ</mo><msup><mi>â„</mi><mrow><mi>n</mi><mo>Ã—</mo><mi>k</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{G} \in \mathbb{R}^{n \times k}</annotation></semantics></math>
where:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mrow><mi>log</mi><mo>â¡</mo></mrow><mn>2</mn></msub><mo stretchy="false" form="prefix">(</mo><mrow><mtext mathvariant="normal">mean expression of gene </mtext><mspace width="0.333em"></mspace></mrow><mi>i</mi><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> in cell type </mtext><mspace width="0.333em"></mspace></mrow><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">G_{ij} = \log_2(\text{mean expression of gene } i \text{ in cell type } j + 1)</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="unit-hypersphere-normalization">Unit Hypersphere Normalization<a class="anchor" aria-label="anchor" href="#unit-hypersphere-normalization"></a>
</h3>
<p>To compare genes fairly regardless of their absolute expression
levels, we normalize each gene vector to lie on the unit
hypersphere:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>ğ </mi><mo accent="true">Ì‚</mo></mover><mi>i</mi></msub><mo>=</mo><mfrac><msub><mi>ğ </mi><mi>i</mi></msub><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ </mi><mi>i</mi></msub><msub><mo stretchy="false" form="postfix">âˆ¥</mo><mn>2</mn></msub></mrow></mfrac><mo>=</mo><mfrac><msub><mi>ğ </mi><mi>i</mi></msub><msqrt><mrow><munderover><mo>âˆ‘</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><msubsup><mi>g</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup></mrow></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\hat{\mathbf{g}}_i = \frac{\mathbf{g}_i}{\|\mathbf{g}_i\|_2} = \frac{\mathbf{g}_i}{\sqrt{\sum_{j=1}^{k} g_{ij}^2}}</annotation></semantics></math></p>
<p>After normalization, all gene vectors have unit length
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mover><mi>ğ </mi><mo accent="true">Ì‚</mo></mover><mi>i</mi></msub><mo stretchy="false" form="postfix">âˆ¥</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\|\hat{\mathbf{g}}_i\| = 1</annotation></semantics></math>),
allowing us to focus purely on their directional properties.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstration of hypersphere normalization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">gene_expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">2</span>, <span class="fl">1</span>,   <span class="co"># Gene 1: high in type A</span></span>
<span>                      <span class="fl">3</span>, <span class="fl">8</span>, <span class="fl">2</span>,    <span class="co"># Gene 2: high in type B  </span></span>
<span>                      <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>,   <span class="co"># Gene 3: high in type C</span></span>
<span>                    nrow <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Gene"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, </span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Type"</span>, <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Normalize to unit sphere</span></span>
<span><span class="va">normalize_sphere</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">/</span> <span class="va">lengths</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gene_normalized</span> <span class="op">&lt;-</span> <span class="fu">normalize_sphere</span><span class="op">(</span><span class="va">gene_expr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original gene vectors:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original gene vectors:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">gene_expr</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       TypeA TypeB TypeC</span></span>
<span><span class="co">#&gt; Gene1    10     2     1</span></span>
<span><span class="co">#&gt; Gene2     3     8     2</span></span>
<span><span class="co">#&gt; Gene3     1     1     5</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nNormalized vectors (unit length):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Normalized vectors (unit length):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">gene_normalized</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       TypeA TypeB TypeC</span></span>
<span><span class="co">#&gt; Gene1 0.976 0.195 0.098</span></span>
<span><span class="co">#&gt; Gene2 0.342 0.912 0.228</span></span>
<span><span class="co">#&gt; Gene3 0.192 0.192 0.962</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nVector lengths (all = 1):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Vector lengths (all = 1):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">gene_normalized</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gene1 Gene2 Gene3 </span></span>
<span><span class="co">#&gt;     1     1     1</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="marker-gene-selection">Marker Gene Selection<a class="anchor" aria-label="anchor" href="#marker-gene-selection"></a>
</h2>
<div class="section level3">
<h3 id="angular-distance-criterion">Angular Distance Criterion<a class="anchor" aria-label="anchor" href="#angular-distance-criterion"></a>
</h3>
<p>The quality of a marker gene for cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
is determined by the <strong>angular distance</strong> from the unit
vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ğ</mi><mi>c</mi></msub><annotation encoding="application/x-tex">\mathbf{e}_c</annotation></semantics></math>
corresponding to that cell type:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î¸</mi><mi>c</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>ğ </mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi>arccos</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>ğ </mi><mo accent="true">Ì‚</mo></mover><mo>â‹…</mo><msub><mi>ğ</mi><mi>c</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mi>arccos</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>g</mi><mo accent="true">Ì‚</mo></mover><mi>c</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\theta_c(\mathbf{g}) = \arccos\left(\hat{\mathbf{g}} \cdot \mathbf{e}_c\right) = \arccos\left(\hat{g}_c\right)</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>g</mi><mo accent="true">Ì‚</mo></mover><mi>c</mi></msub><annotation encoding="application/x-tex">\hat{g}_c</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>-th
component of the normalized gene vector.</p>
<p><strong>Interpretation:</strong> -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¸</mi><mo>=</mo><mn>0</mn><mi>Â°</mi></mrow><annotation encoding="application/x-tex">\theta = 0Â°</annotation></semantics></math>:
Perfect marker (expressed only in cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>)
-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¸</mi><mo>=</mo><mn>45</mn><mi>Â°</mi></mrow><annotation encoding="application/x-tex">\theta = 45Â°</annotation></semantics></math>:
Moderate specificity -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¸</mi><mo>=</mo><mn>90</mn><mi>Â°</mi></mrow><annotation encoding="application/x-tex">\theta = 90Â°</annotation></semantics></math>:
No association with cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate angles from each coordinate axis</span></span>
<span><span class="va">angles_rad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">acos</a></span><span class="op">(</span><span class="va">gene_normalized</span><span class="op">)</span></span>
<span><span class="va">angles_deg</span> <span class="op">&lt;-</span> <span class="va">angles_rad</span> <span class="op">*</span> <span class="fl">180</span> <span class="op">/</span> <span class="va">pi</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Angular distance (degrees) to each cell type axis:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Angular distance (degrees) to each cell type axis:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">angles_deg</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       TypeA TypeB TypeC</span></span>
<span><span class="co">#&gt; Gene1  12.6  78.7  84.4</span></span>
<span><span class="co">#&gt; Gene2  70.0  24.3  76.8</span></span>
<span><span class="co">#&gt; Gene3  78.9  78.9  15.8</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nBest marker for each cell type:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Best marker for each cell type:</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">best_gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">angles_deg</span><span class="op">[</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %s: %s (%.1fÂ°)\n"</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">angles_deg</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">angles_deg</span><span class="op">)</span><span class="op">[</span><span class="va">best_gene</span><span class="op">]</span>,</span>
<span>              <span class="va">angles_deg</span><span class="op">[</span><span class="va">best_gene</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;   TypeA: Gene1 (12.6&lt;U+00B0&gt;)</span></span>
<span><span class="co">#&gt;   TypeB: Gene2 (24.3&lt;U+00B0&gt;)</span></span>
<span><span class="co">#&gt;   TypeC: Gene3 (15.8&lt;U+00B0&gt;)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="marker-selection-algorithm">Marker Selection Algorithm<a class="anchor" aria-label="anchor" href="#marker-selection-algorithm"></a>
</h3>
<p>For each cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>,
genes are ranked by:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Primary criterion</strong>: Smallest angle
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î¸</mi><mi>c</mi></msub><annotation encoding="application/x-tex">\theta_c</annotation></semantics></math>
</li>
<li>
<strong>Secondary criterion</strong>: Highest maximum expression (to
favor robustly expressed genes)</li>
</ol>
<p>The top
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
genes (default: 25) for each cell type form the signature matrix.</p>
</div>
</div>
<div class="section level2">
<h2 id="vector-dot-product-deconvolution">Vector Dot Product Deconvolution<a class="anchor" aria-label="anchor" href="#vector-dot-product-deconvolution"></a>
</h2>
<div class="section level3">
<h3 id="mathematical-framework">Mathematical Framework<a class="anchor" aria-label="anchor" href="#mathematical-framework"></a>
</h3>
<p>Given: - Signature matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ’</mi><mo>âˆˆ</mo><msup><mi>â„</mi><mrow><mi>m</mi><mo>Ã—</mo><mi>k</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{S} \in \mathbb{R}^{m \times k}</annotation></semantics></math>
(m signature genes, k cell types) - Bulk sample vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ›</mi><mo>âˆˆ</mo><msup><mi>â„</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{b} \in \mathbb{R}^{m}</annotation></semantics></math></p>
<p>The raw cell type contributions are computed via <strong>vector
projection</strong>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>c</mi></msub><mo>=</mo><msub><mtext mathvariant="normal">proj</mtext><msub><mi>ğ¬</mi><mi>c</mi></msub></msub><mo stretchy="false" form="prefix">(</mo><mi>ğ›</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><mi>ğ›</mi><mo>â‹…</mo><msub><mi>ğ¬</mi><mi>c</mi></msub></mrow><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mi>c</mi></msub><msup><mo stretchy="false" form="postfix">âˆ¥</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">p_c = \text{proj}_{\mathbf{s}_c}(\mathbf{b}) = \frac{\mathbf{b} \cdot \mathbf{s}_c}{\|\mathbf{s}_c\|^2}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ğ¬</mi><mi>c</mi></msub><annotation encoding="application/x-tex">\mathbf{s}_c</annotation></semantics></math>
is the signature vector for cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>.</p>
<p>In matrix form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ©</mi><mo>=</mo><msup><mi>ğ›</mi><mi>T</mi></msup><mi>ğ’</mi><mo>â‹…</mo><mtext mathvariant="normal">diag</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mn>1</mn></msub><msup><mo stretchy="false" form="postfix">âˆ¥</mo><mn>2</mn></msup></mrow></mfrac><mo>,</mo><mi>â€¦</mi><mo>,</mo><mfrac><mn>1</mn><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mi>k</mi></msub><msup><mo stretchy="false" form="postfix">âˆ¥</mo><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{p} = \mathbf{b}^T \mathbf{S} \cdot \text{diag}\left(\frac{1}{\|\mathbf{s}_1\|^2}, \ldots, \frac{1}{\|\mathbf{s}_k\|^2}\right)</annotation></semantics></math></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstration of vector projection</span></span>
<span><span class="va">signature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">1</span>, <span class="fl">0</span>,   <span class="co"># Marker 1 for Type A</span></span>
<span>                      <span class="fl">1</span>, <span class="fl">7</span>, <span class="fl">0</span>,   <span class="co"># Marker 2 for Type B</span></span>
<span>                      <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span>,  <span class="co"># Marker 3 for Type C</span></span>
<span>                    nrow <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">signature</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Type"</span>, <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulated bulk sample (40% A, 35% B, 25% C)</span></span>
<span><span class="va">bulk</span> <span class="op">&lt;-</span> <span class="va">signature</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.40</span>, <span class="fl">0.35</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Vector projection</span></span>
<span><span class="va">col_squared_norms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">signature</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">bulk</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">signature</span> <span class="op">/</span> <span class="va">col_squared_norms</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">projections</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">signature</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Signature matrix:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Signature matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">signature</span><span class="op">)</span></span>
<span><span class="co">#&gt;      TypeA TypeB TypeC</span></span>
<span><span class="co">#&gt; [1,]     8     1     0</span></span>
<span><span class="co">#&gt; [2,]     1     7     0</span></span>
<span><span class="co">#&gt; [3,]     0     1     6</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nBulk sample:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bulk sample:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">bulk</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.55 2.85 1.85</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRaw projections:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Raw projections:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">projections</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; TypeA TypeB TypeC </span></span>
<span><span class="co">#&gt; 0.481 0.497 0.308</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nPercentages:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Percentages:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">projections</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">projections</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; TypeA TypeB TypeC </span></span>
<span><span class="co">#&gt;  37.4  38.6  24.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="equal-weight-transformation">Equal Weight Transformation<a class="anchor" aria-label="anchor" href="#equal-weight-transformation"></a>
</h3>
<p>To prevent highly expressed genes from dominating the deconvolution,
we apply equal weighting:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mrow><mi>i</mi><mo>,</mo><mi>â‹…</mi></mrow></msub><msub><mo stretchy="false" form="postfix">âˆ¥</mo><mn>2</mn></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">w_i = \frac{1}{\|\mathbf{s}_{i,\cdot}\|_2}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ğ¬</mi><mrow><mi>i</mi><mo>,</mo><mi>â‹…</mi></mrow></msub><annotation encoding="application/x-tex">\mathbf{s}_{i,\cdot}</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>-th
row (gene) of the signature matrix.</p>
<p>The weighted projection becomes:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mi>c</mi><mrow><mo stretchy="false" form="prefix">(</mo><mi>w</mi><mo stretchy="false" form="postfix">)</mo></mrow></msubsup><mo>=</mo><mfrac><mrow><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><mo>â‹…</mo><msub><mi>b</mi><mi>i</mi></msub><mo>â‹…</mo><msub><mi>s</mi><mrow><mi>i</mi><mi>c</mi></mrow></msub></mrow><mrow><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><msub><mi>w</mi><mi>i</mi></msub><mo>â‹…</mo><msubsup><mi>s</mi><mrow><mi>i</mi><mi>c</mi></mrow><mn>2</mn></msubsup></mrow></mfrac></mrow><annotation encoding="application/x-tex">p_c^{(w)} = \frac{\sum_{i=1}^{m} w_i \cdot b_i \cdot s_{ic}}{\sum_{i=1}^{m} w_i \cdot s_{ic}^2}</annotation></semantics></math></p>
</div>
</div>
<div class="section level2">
<h2 id="spillover-and-compensation">Spillover and Compensation<a class="anchor" aria-label="anchor" href="#spillover-and-compensation"></a>
</h2>
<div class="section level3">
<h3 id="the-spillover-problem">The Spillover Problem<a class="anchor" aria-label="anchor" href="#the-spillover-problem"></a>
</h3>
<p>When cell types have similar expression profiles, projection onto one
cell typeâ€™s signature will capture signal from related cell types. This
â€œspilloverâ€ can be quantified using the spillover matrix:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğŒ</mi><mo>=</mo><msup><mi>ğ’</mi><mi>T</mi></msup><mi>ğ’</mi><mo>â‹…</mo><mtext mathvariant="normal">diag</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mn>1</mn></msub><msup><mo stretchy="false" form="postfix">âˆ¥</mo><mn>2</mn></msup></mrow></mfrac><mo>,</mo><mi>â€¦</mi><mo>,</mo><mfrac><mn>1</mn><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mi>k</mi></msub><msup><mo stretchy="false" form="postfix">âˆ¥</mo><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{M} = \mathbf{S}^T \mathbf{S} \cdot \text{diag}\left(\frac{1}{\|\mathbf{s}_1\|^2}, \ldots, \frac{1}{\|\mathbf{s}_k\|^2}\right)</annotation></semantics></math></p>
<p>Properties of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğŒ</mi><annotation encoding="application/x-tex">\mathbf{M}</annotation></semantics></math>:
- Diagonal elements = 1 (perfect self-projection) - Off-diagonal
elements indicate cross-talk between cell types</p>
</div>
<div class="section level3">
<h3 id="compensation-matrix">Compensation Matrix<a class="anchor" aria-label="anchor" href="#compensation-matrix"></a>
</h3>
<p>To correct for spillover, we apply the inverse of the spillover
matrix:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>ğ©</mi><mo accent="true">Ì‚</mo></mover><mo>=</mo><msup><mi>ğŒ</mi><mrow><mi>âˆ’</mi><mn>1</mn></mrow></msup><mo>â‹…</mo><mi>ğ©</mi></mrow><annotation encoding="application/x-tex">\hat{\mathbf{p}} = \mathbf{M}^{-1} \cdot \mathbf{p}</annotation></semantics></math></p>
<p>This ensures that if the bulk sample truly contains only cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>,
the compensated output shows 100% for cell type
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
and 0% for all others.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spillover matrix calculation</span></span>
<span><span class="va">col_norms_sq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">signature</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">spillover</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">signature</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">signature</span> <span class="op">/</span> <span class="va">col_norms_sq</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Spillover matrix:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Spillover matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">spillover</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       TypeA TypeB TypeC</span></span>
<span><span class="co">#&gt; TypeA 1.000 0.231 0.000</span></span>
<span><span class="co">#&gt; TypeB 0.294 1.000 0.118</span></span>
<span><span class="co">#&gt; TypeC 0.000 0.167 1.000</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCompensation matrix (inverse):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Compensation matrix (inverse):</span></span>
<span><span class="va">compensation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">spillover</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">compensation</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;        TypeA  TypeB  TypeC</span></span>
<span><span class="co">#&gt; TypeA  1.074 -0.253  0.030</span></span>
<span><span class="co">#&gt; TypeB -0.322  1.096 -0.129</span></span>
<span><span class="co">#&gt; TypeC  0.054 -0.183  1.021</span></span>
<span></span>
<span><span class="co"># Apply compensation</span></span>
<span><span class="va">raw_projections</span> <span class="op">&lt;-</span> <span class="va">projections</span></span>
<span><span class="va">compensated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">compensation</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">raw_projections</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">compensated</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">signature</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRaw vs Compensated projections:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Raw vs Compensated projections:</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Raw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">raw_projections</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                         Compensated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">compensated</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                         True <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.40</span>, <span class="fl">0.35</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Raw Compensated True</span></span>
<span><span class="co">#&gt; TypeA 0.481        0.40 0.40</span></span>
<span><span class="co">#&gt; TypeB 0.497        0.35 0.35</span></span>
<span><span class="co">#&gt; TypeC 0.308        0.25 0.25</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="cosine-similarity-analysis">Cosine Similarity Analysis<a class="anchor" aria-label="anchor" href="#cosine-similarity-analysis"></a>
</h2>
<div class="section level3">
<h3 id="definition">Definition<a class="anchor" aria-label="anchor" href="#definition"></a>
</h3>
<p>The <strong>cosine similarity</strong> between two cell type
signatures measures their angular relationship:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>cos</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>Î¸</mi><mrow><mi>a</mi><mi>b</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><msub><mi>ğ¬</mi><mi>a</mi></msub><mo>â‹…</mo><msub><mi>ğ¬</mi><mi>b</mi></msub></mrow><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mi>a</mi></msub><mo stretchy="false" form="postfix">âˆ¥</mo><mi>â‹…</mi><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>ğ¬</mi><mi>b</mi></msub><mo stretchy="false" form="postfix">âˆ¥</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\cos(\theta_{ab}) = \frac{\mathbf{s}_a \cdot \mathbf{s}_b}{\|\mathbf{s}_a\| \cdot \|\mathbf{s}_b\|}</annotation></semantics></math></p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>cos</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\cos(\theta) = 1</annotation></semantics></math>:
Identical signatures (problematic)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>cos</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\cos(\theta) = 0</annotation></semantics></math>:
Orthogonal signatures (ideal)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>cos</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\cos(\theta) &lt; 0</annotation></semantics></math>:
Opposite patterns (rare)</li>
</ul>
</div>
<div class="section level3">
<h3 id="diagnostic-application">Diagnostic Application<a class="anchor" aria-label="anchor" href="#diagnostic-application"></a>
</h3>
<p>High cosine similarity between cell types indicates: 1. Potential
difficulty in distinguishing them during deconvolution 2. Need to
consider merging or removing one cell type 3. Biological relatedness
that may require careful interpretation</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate cosine similarity</span></span>
<span><span class="va">cosine_sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">norms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">S</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">S</span> <span class="op">/</span> <span class="op">(</span><span class="va">norms</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="va">norms</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Extended example with similar cell types</span></span>
<span><span class="va">signature_extended</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  TypeA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  TypeB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  TypeC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  TypeA_sub <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>  <span class="co"># Similar to TypeA</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cos_matrix</span> <span class="op">&lt;-</span> <span class="fu">cosine_sim</span><span class="op">(</span><span class="va">signature_extended</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cosine similarity matrix:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cosine similarity matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cos_matrix</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           TypeA TypeB TypeC TypeA_sub</span></span>
<span><span class="co">#&gt; TypeA     1.000 0.329 0.059     0.989</span></span>
<span><span class="co">#&gt; TypeB     0.329 1.000 0.211     0.466</span></span>
<span><span class="co">#&gt; TypeC     0.059 0.211 1.000     0.086</span></span>
<span><span class="co">#&gt; TypeA_sub 0.989 0.466 0.086     1.000</span></span>
<span></span>
<span><span class="co"># Convert to angles</span></span>
<span><span class="va">angle_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">acos</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">cos_matrix</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">180</span> <span class="op">/</span> <span class="va">pi</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAngular distance (degrees):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Angular distance (degrees):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">angle_matrix</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           TypeA TypeB TypeC TypeA_sub</span></span>
<span><span class="co">#&gt; TypeA       0.0  70.8  86.6       8.7</span></span>
<span><span class="co">#&gt; TypeB      70.8   0.0  77.8      62.3</span></span>
<span><span class="co">#&gt; TypeC      86.6  77.8   0.0      85.1</span></span>
<span><span class="co">#&gt; TypeA_sub   8.7  62.3  85.1       0.0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="noise-reduction">Noise Reduction<a class="anchor" aria-label="anchor" href="#noise-reduction"></a>
</h2>
<div class="section level3">
<h3 id="threshold-based-filtering">Threshold-Based Filtering<a class="anchor" aria-label="anchor" href="#threshold-based-filtering"></a>
</h3>
<p>To reduce the impact of non-specific background expression,
cellGeometry applies a noise filter:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>s</mi><mo accent="true">Ìƒ</mo></mover><mrow><mi>i</mi><mi>c</mi></mrow></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><msub><mi>s</mi><mrow><mi>i</mi><mi>c</mi></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><msub><mi>s</mi><mrow><mi>i</mi><mi>c</mi></mrow></msub><mo>â‰¥</mo><mi>f</mi><mo>â‹…</mo><munder><mi>max</mi><mi>j</mi></munder><mo stretchy="false" form="prefix">(</mo><msub><mi>s</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\tilde{s}_{ic} = \begin{cases} s_{ic} &amp; \text{if } s_{ic} \geq f \cdot \max_j(s_{ij}) \\ 0 &amp; \text{otherwise} \end{cases}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>f</mi><annotation encoding="application/x-tex">f</annotation></semantics></math>
is the <code>noisefraction</code> parameter (default: 0.25).</p>
<p>This ensures that only expression values above a certain fraction of
the geneâ€™s maximum are retained in the signature.</p>
</div>
<div class="section level3">
<h3 id="effect-on-deconvolution">Effect on Deconvolution<a class="anchor" aria-label="anchor" href="#effect-on-deconvolution"></a>
</h3>
<p>Noise filtering: - Reduces compensation burden - Improves specificity
of markers - May increase sensitivity to missing cell types</p>
</div>
</div>
<div class="section level2">
<h2 id="multi-pass-deconvolution">Multi-Pass Deconvolution<a class="anchor" aria-label="anchor" href="#multi-pass-deconvolution"></a>
</h2>
<div class="section level3">
<h3 id="outlier-detection">Outlier Detection<a class="anchor" aria-label="anchor" href="#outlier-detection"></a>
</h3>
<p>cellGeometry implements iterative outlier detection to identify and
remove problematic genes:</p>
<ol style="list-style-type: decimal">
<li>Perform initial deconvolution</li>
<li>Compute studentized residuals for each gene</li>
<li>Flag genes with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">|</mo><msubsup><mi>r</mi><mi>i</mi><mo>*</mo></msubsup><mo stretchy="false" form="prefix">|</mo><mo>&gt;</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">|r_i^*| &gt; 3</annotation></semantics></math>
as outliers</li>
<li>Repeat deconvolution without outliers</li>
<li>Continue until convergence</li>
</ol>
</div>
<div class="section level3">
<h3 id="studentized-residuals">Studentized Residuals<a class="anchor" aria-label="anchor" href="#studentized-residuals"></a>
</h3>
<p>The studentized residual for gene
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>r</mi><mi>i</mi><mo>*</mo></msubsup><mo>=</mo><mfrac><msub><mi>e</mi><mi>i</mi></msub><mrow><mover><mi>Ïƒ</mi><mo accent="true">Ì‚</mo></mover><msqrt><mrow><mn>1</mn><mo>âˆ’</mo><msub><mi>h</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">r_i^* = \frac{e_i}{\hat{\sigma}\sqrt{1 - h_{ii}}}</annotation></semantics></math></p>
<p>where: -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub><mo>=</mo><msub><mi>y</mi><mi>i</mi></msub><mo>âˆ’</mo><msub><mover><mi>y</mi><mo accent="true">Ì‚</mo></mover><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i = y_i - \hat{y}_i</annotation></semantics></math>
is the raw residual -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>Ïƒ</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\sigma}</annotation></semantics></math>
is the estimated standard error -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>h</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">h_{ii}</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>-th
diagonal element of the hat matrix</p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The cellGeometry algorithm combines several geometric principles:</p>
<table class="table">
<colgroup>
<col width="28%">
<col width="48%">
<col width="23%">
</colgroup>
<thead><tr class="header">
<th>Component</th>
<th>Mathematical Basis</th>
<th>Purpose</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Hypersphere normalization</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="postfix">âˆ¥</mo><mover><mi>ğ </mi><mo accent="true">Ì‚</mo></mover><mo stretchy="false" form="postfix">âˆ¥</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\|\hat{\mathbf{g}}\| = 1</annotation></semantics></math></td>
<td>Scale-invariant gene comparison</td>
</tr>
<tr class="even">
<td>Angular distance</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¸</mi><mo>=</mo><mrow><mi>arccos</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><msub><mover><mi>g</mi><mo accent="true">Ì‚</mo></mover><mi>c</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\theta = \arccos(\hat{g}_c)</annotation></semantics></math></td>
<td>Marker gene selection</td>
</tr>
<tr class="odd">
<td>Vector projection</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">proj</mtext><mi>ğ¯</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>ğ®</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\text{proj}_\mathbf{v}(\mathbf{u})</annotation></semantics></math></td>
<td>Cell type contribution estimation</td>
</tr>
<tr class="even">
<td>Spillover matrix</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğŒ</mi><mo>=</mo><msup><mi>ğ’</mi><mi>T</mi></msup><mi>ğ’</mi></mrow><annotation encoding="application/x-tex">\mathbf{M} = \mathbf{S}^T\mathbf{S}</annotation></semantics></math></td>
<td>Cross-talk quantification</td>
</tr>
<tr class="odd">
<td>Compensation</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğŒ</mi><mrow><mi>âˆ’</mi><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">\mathbf{M}^{-1}</annotation></semantics></math></td>
<td>Cross-talk correction</td>
</tr>
</tbody>
</table>
<p>This geometric framework provides: -
<strong>Interpretability</strong>: Results have clear geometric meaning
- <strong>Efficiency</strong>: Matrix operations enable fast computation
- <strong>Robustness</strong>: Compensation corrects for signature
overlap</p>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.4.0 (2024-04-24)</span></span>
<span><span class="co">#&gt; Platform: aarch64-apple-darwin20</span></span>
<span><span class="co">#&gt; Running under: macOS 15.6.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib </span></span>
<span><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt; [1] C</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: Asia/Shanghai</span></span>
<span><span class="co">#&gt; tzcode source: internal</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] digest_0.6.39     desc_1.4.3        R6_2.6.1          fastmap_1.2.0    </span></span>
<span><span class="co">#&gt;  [5] xfun_0.56         cachem_1.1.0      knitr_1.51        htmltools_0.5.9  </span></span>
<span><span class="co">#&gt;  [9] rmarkdown_2.30    lifecycle_1.0.5   cli_3.6.5         sass_0.4.10      </span></span>
<span><span class="co">#&gt; [13] pkgdown_2.2.0     textshaping_1.0.4 jquerylib_0.1.4   systemfonts_1.3.1</span></span>
<span><span class="co">#&gt; [17] compiler_4.4.0    tools_4.4.0       ragg_1.5.0        bslib_0.9.0      </span></span>
<span><span class="co">#&gt; [21] evaluate_1.0.5    yaml_2.3.12       otel_0.2.0        jsonlite_2.0.0   </span></span>
<span><span class="co">#&gt; [25] rlang_1.1.7       fs_1.6.6          htmlwidgets_1.6.4</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/Zaoqu-Liu" class="external-link">Zaoqu Liu</a> and <a href="https://github.com/myles-lewis" class="external-link">Myles Lewis</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
